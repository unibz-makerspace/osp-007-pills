#include "Fotocellula.h"

unsigned short int Fotocellula::calibra(const unsigned short int pinSensore, const unsigned int intervalloCampionamento, const unsigned int numeroCampionamenti, unsigned short int percentualeSoglia)
{ 
  static unsigned long istantePrecedente = 0;
  unsigned short int valoreSensore;
  unsigned int somma = 0;
  static unsigned short int valoreMedioSensore = map(analogRead(pinSensore), 0, 1023, 0, 255);
  
  if ((millis() - istantePrecedente) > intervalloCampionamento)
  {
    istantePrecedente = millis();

    valoreSensore = map(analogRead(pinSensore), 0, 1023, 0, 255);

    somma = valoreSensore;    
    for(int i = numeroCampionamenti - 1; i > 0; i--)
    {
      s_valoriSensore[i] = s_valoriSensore[i - 1]; 
      somma += s_valoriSensore[i]; 
    }

    s_valoriSensore[0] = valoreSensore;

    valoreMedioSensore = somma / numeroCampionamenti;

    s_soglia = valoreMedioSensore * p_percentualeSoglia / 100; 
  }  
	
  return valoreMedioSensore * p_percentualeSoglia / 100;
}

unsigned short int inizializzaCalibrazione(const unsigned short int pinSensore, const unsigned int numeroCampionamenti, unsigned short int percentualeSoglia)
{
  unsigned int somma = 0;
  for(int i = 0; i < NUMERO_CAMPIONAMENTI; i++)
  {
//    s_valoriSensore[i] = map(analogRead(pinSensore), 0, 1023, 0, 255);
//    somma += s_valoriSensore[i]; 
  }	

  s_soglia = (somma / numeroCampionamenti) * p_percentualeSoglia / 100;	

  return somma / numeroCampionamenti;	
}

Fotocellula::Fotocellula(unsigned short int fotocellulaPin, unsigned short int percentualeSoglia)
{ 
  p_fotocellulaPin = fotocellulaPin;
  p_percentualeSoglia = percentualeSoglia;
  pinMode(p_fotocellulaPin, INPUT);
}

boolean Fotocellula::aggiorna()
{
  int valoreSensore = analogRead(p_fotocellulaPin);
  valoreSensore = map(valoreSensore, 0, 1023, 0, 255);
//  valoreSensore = constrain(valoreSensore, 0, 255);
  
  boolean segnale = false;
  
  if (valoreSensore < s_soglia)
    segnale = true;
  
  Serial.print(valoreSensore); Serial.print("-"); Serial.println(segnale);

  return segnale;
}

